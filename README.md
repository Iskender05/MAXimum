# MAXimum Security Bot

MAXimum - это бот безопасности, который помогает защитить пользователей от вредоносных ссылок и файлов, проверяя их с помощью сервисов обнаружения угроз Kaspersky.

## Возможности

- Автоматическая проверка ссылок и файлов, которыми делятся в чатах
- Интеграция с Kaspersky OpenTIP для обнаружения угроз
- Работает как в приватных беседах, так и в групповых чатах
- Предупреждает об опасных пользователях на основе исторических данных
- Обратная связь в реальном времени по безопасности ссылок и файлов
- Интерактивные функции: тесты по кибербезопасности и советы

## Требования

Перед началом убедитесь, что у вас установлены следующие компоненты:
- Docker и Docker Compose
- Node.js (если запускаете без Docker)
- PostgreSQL (если запускаете без Docker)
- RabbitMQ (если запускаете без Docker)

## Переменные окружения

Создайте файл `.env` в корне проекта со следующими переменными:

```env
BOT_TOKEN=ваш_токен_бота
DATABASE_URL=postgres://пользователь:пароль@хост:5432/имя_базы
AMQP_URL=amqp://пользователь:пароль@rabbit:5672
QUEUE_NAME=check
KASPERSKY_API_KEY=ваш_api_ключ_kaspersky
KASPERSKY_URL_API=https://opentip.kaspersky.com/api/v1/search/domain
KASPERSKY_TIMEOUT_MS=3000
```

## Запуск с помощью Docker (Рекомендуется)

### Сборка и запуск сервисов

1. Клонируйте репозиторий:
   ```bash
   git clone <адрес-репозитория>
   cd MAXimum
   ```

2. Создайте и настройте ваш файл `.env` с необходимыми переменными.

3. Соберите и запустите все сервисы:
   ```bash
   docker-compose up --build
   ```

### Запуск в фоновом режиме

Чтобы запустить сервисы в фоне:
```bash
docker-compose up --build -d
```

### Остановка сервисов

Чтобы остановить все сервисы:
```bash
docker-compose down
```

### Просмотр логов

Чтобы просмотреть логи всех сервисов:
```bash
docker-compose logs -f
```

Чтобы просмотреть логи определенного сервиса:
```bash
docker-compose logs -f bot
# или
docker-compose logs -f worker
```

## Локальный запуск (Без Docker)

### Установка зависимостей

1. Установите зависимости Node.js:
   ```bash
   npm install
   ```

2. Убедитесь, что PostgreSQL и RabbitMQ запущены и правильно сконфигурированы.

### Настройка базы данных

Выполните SQL-скрипт для инициализации базы данных:
```sql
-- Выполните содержимое src/db/init.sql в вашей базе данных PostgreSQL
```

### Запуск сервисов

Запустите сервис бота:
```bash
npm run start:bot
```

Запустите сервис обработчика:
```bash
npm run start:worker
```

## Конфигурация

### Обзор сервисов

- **База данных**: PostgreSQL 16-alpine
- **Очередь сообщений**: RabbitMQ 3-management-alpine
- **Сервис бота**: Обрабатывает входящие сообщения и взаимодействие с пользователями
- **Сервис обработчика**: Обрабатывает проверку URL и файлов в фоновом режиме

### Основные компоненты

1. **Обработчик бота** (`src/bot/handler.js`): 
   - Слушает входящие сообщения
   - Извлекает URL и файлы из сообщений
   - Ставит их в очередь на обработку
   - Обрабатывает интерактивные команды (тесты, советы)
   
2. **Обработчик** (`src/worker/index.js`):
   - Потребляет сообщения из очереди
   - Проверяет URL/файлы с помощью Kaspersky
   - Отправляет результаты пользователям
   
3. **Запросы к базе данных** (`src/db/queries.js`):
   - Управляет хранением данных о URL и пользователях
   - Отслеживает потенциально опасных пользователей
   
4. **Интеграция с Kaspersky** (`src/services/kaspersky.js`):
   - Взаимодействует с API Kaspersky OpenTIP
   - Выполняет проверки безопасности URL и файлов

## Использование

1. Добавьте бота в групповой чат или начните приватную беседу с ним.
2. При отправке ссылок или файлов бот автоматически проверит их.
3. Бот ответит статусом безопасности каждого элемента.
4. При добавлении новых пользователей в группу бот проверит их историю и предупредит при необходимости.
5. В приватной беседе можно использовать интерактивные функции бота:
   - Пройти тесты по кибербезопасности
   - Получить советы по безопасности

## Устранение неполадок

### Частые проблемы

1. **Бот не отвечает**: Проверьте, что все сервисы запущены и BOT_TOKEN правильно установлен.
2. **Ошибки подключения к базе данных**: Проверьте DATABASE_URL и доступность PostgreSQL.
3. **Задержки обработки очереди**: Проверьте подключение к RabbitMQ и работу обработчика.

### Проверка статуса сервисов

```bash
# Проверка запущенных контейнеров
docker-compose ps

# Проверка логов конкретного сервиса
docker-compose logs имя_сервиса
```